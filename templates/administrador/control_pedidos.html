{% extends "administrador/admin_dashboard.html" %}
{% block title %}control_pedidos | Casa en el Árbol{% endblock %}

{% block extra_css %}
<style>



:root {
    --primary-green: #5f8f3f;
    --secondary-green: #4e7b33;
    --light-green: #6c9a50;
    --accent-green: #7cb342;
    --bg-cream: #f8f6f0;
    --text-dark: #2c3e50;
    --shadow-light: rgba(0, 0, 0, 0.08);
    --shadow-medium: rgba(0, 0, 0, 0.15);
}

/* Encabezado */
.encabezado{
    width: 90%;
    background: linear-gradient(90deg, var(--primary-green), var(--accent-green));
    color: white;
    border-radius: 0 0 10px 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: fixed;
    left: 10%;
}

/* Contenedor principal */
.contenedor-pedidos{
   text-align: center;
   min-height: 400px;
   width: 100%;
   margin-left: 30px;
}

/* Contenido de pedidos */
.content-pedidos{
    justify-content: center;
    margin-top: 20px;
    display: flex;
    background-color: #fcfcfc;
    width: 80%;
    margin-left: 15%;
    border:1px solid #e6e6e6;
    border-radius: 10px;
    min-height: 700px;
}

.pedidos{
    background-color: #fff;
    width: 95%;
    padding: 10px;
    margin: 10px 0;
    font-size: 13px;
    border-radius: 10px;
    border:1px solid #d8d7d7;
}

.pedidos p{
    margin-left: 15px;
}

/* Sidebar */
.opciones1{
    border:1px solid #d8d7d7;
    background-color: white;
    border-radius: 10px;
    position: sticky;
    top: 110px;     /* Ajusta según la altura del encabezado */
    z-index: 10;
    bottom: 0;
    height: 500px;
    width: 8%;
    margin-top: 20px;
}

a p{
    text-decoration: none;
    display: none;

    
}

button p{
  display: none;
}

a{
  display: flex;
  text-decoration: none;
  margin-bottom: 0;
}



.opciones1:hover{
  width: 220px;
}

.opciones1:hover button p, .opciones1:hover a p{
  display: block;
}


h2{
    color: #628D46;
    margin-top: 20px;
    margin-bottom: 30px;
}

h1{
    padding: 20px;
}

.datos-pedido{
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

  form{
            margin: 20px 0 0 4%;
            border:1px solid #e6e6e6;
            background-color: #fff;
            width: 80%;
            bottom: 370px;
            border-radius: 10px;
            font-size: 20px;
        }

        form input{
            width: 50%;
            text-align: left;
            margin-right: 20px;
        }

        select{
            height: 40px;
            width: 150px;
            font-size: 18px;
            border-radius: 10px;
        }


        h2{
            color: #628D46;
            margin-top: 20px;
            margin-bottom: 30px;
            margin-left: 30%;
        }

        h1{
            padding: 20px;
        }


        .content{
            color: black;
 
        }

        textarea{
            width: 80%;
        }

        form button{
            background-color: #7db243;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10pxn 30px;
            width: 250px;
            height: 50px;
        }

        form button:hover{
            background-color: transparent;
            color: #7db243;
            border: 1px solid #7db243;
        }

        .sidebar{
          margin: 40px 0 20px 20px;
        }

        .btn{
          border: none;
          border-radius: 20px;
          
        }

        .bi{
          font-size: 18px;
        }

        /* Estilo del elemento activo (seleccionado) */
.sidebar a.active {
    background-color: #7db243 !important;
    color: white ;
    height: 50px;
    border-radius: 20px -10px -10px 10px;
    width: 90%;
}



/* Todos los botones vuelven a su color normal */
.sidebar a {
    transition: 0.2s ease;
    background-color: white;
    color: black;
    padding: 10px 20px;
    border-radius: 10px;
    display: block;
    height: 50px;
}

/* Hover: solo el elemento bajo el mouse se pinta */
.btn:hover {
    background-color: #7db243;
    color: white !important;

}

.card {
  width: 90%; 
  margin: 20px 20px 0 2rem;

}

</style>
{% endblock %}

{% block content %}
<div style="display: flex;">
    <!-- Sidebar -->
    <div class="opciones1 shadow-sm" >
        <div class="sidebar ">
            <a id="menu-perfil" class="active" style="display: flex;"><i class="bi bi-box-seam me-2"></i><p>Pedidos</p></a><br>
            <a id="menu-direcciones" style="display: flex;" ><i class="bi bi-chat-square-text me-2"></i><p>Comentarios</p></a><br>
            <a id="menu-pedidos" style="display: flex;" ><i class="bi bi-box2-heart me-2"></i><p>Estado</p></a><br>
            <a id="menu-favoritos" style="display: flex;" ><i class="bi bi-truck me-2"></i><p>Reporte</p></a><br>
            <button type="button" class="btn btn-outline-secondary d-flex align-items-center gap-2 volver"
                    onclick="volverAtras()">
                <i class="bi bi-arrow-left"></i> <p>Volver</p>
            </button>
        </div>
    </div>

    <!-- Contenido principal -->
    <div id="seccion-perfil" class="card shadow-sm p-4" style="">
        <div class="profile-header mb-4">
            <h5 class="mb-0">PERFIL</h5>
        </div>

        {% for pedido in pedidos %}
        <div class="pedidos">
            <div class="contenido">
                <div class="datos-pedido">
                    <p><strong>ID Pedido:</strong> {{ pedido.ID_Pedido }}</p>
                    <p><strong>Cliente:</strong> {{ pedido.cliente }}</p>
                    <p><strong>Empleado:</strong> {{ pedido.empleado }}</p>
                    <p><strong>Fecha Pedido:</strong> {{ pedido.FechaPedido }}</p>
                    <p><strong>Productos:</strong> {{ pedido.productos | safe }}</p>
                    <p><strong>Estado:</strong> {{ pedido.Estado }}</p>
                    <p><strong>Fecha Entrega:</strong> {{ pedido.FechaEntrega or 'No definida' }}</p>
                </div>

                <!-- Botones de acción -->
                <div class="ms-auto">
                    <button class="btn btn-outline-primary ver-factura-btn"
                            data-pedido-id="{{ pedido.ID_Pedido }}">
                        <i class="bi bi-receipt"></i> Ver factura
                    </button>
                    <button class="btn btn-outline-success ver-registros-btn"
                            data-pedido-id="{{ pedido.ID_Pedido }}">
                        <i class="bi bi-truck"></i> Ver entrega
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>


    <div id="seccion-direcciones" class="card shadow-sm p-4" style="display:none;">
        <div class="profile-header mb-4">
          <h5 class="mb-0">COMENTARIOS</h5>
          <div class="content1">
    <h1>Comentarios agrupados por pedido</h1>

    {% for pedido_id, lista in comentarios.items() %}
        <div class="comentario-box">
            <h3>Pedido #{{ pedido_id }}</h3>
            {% for comentario in lista %}
                <div class="comentario">
                    <p>{{ comentario.texto }}</p>
                    <p class="comentario-fecha">Fecha: {{ comentario.fecha }}</p>
                </div>
            {% endfor %}
        </div>
    {% endfor %}
          </div>
        </div>
    </div>
    <div id="seccion-pedidos" class="card shadow-sm p-4 mt-4" style="display:none; ">
      <div class="profile-header mb-4">
        <h5 class="mb-0">ESTADO</h5>
        <form method="POST" action="{{ url_for('admin.actualizar_pedido_route') }}">
        <h2>ACTUALIZACION DE ESTADO</h2>
        <div class="content">
            <label for="pedido_id">ID del pedido:</label><br>
            <input type="number" name="pedido_id" required>

            <label for="estado">Nuevo estado:</label>
            <select name="estado" required>
                <option value="pendiente">Pendiente</option>
                <option value="en proseso">en proceso</option>
                <option value="en reparto">en reparto</option>
                <option value="entregado">entregado</option>
            </select><br><br>

            <label for="comentario">Comentario:</label><br>
            <textarea name="comentario" rows="3"></textarea><br><br>

            <button type="submit">Actualizar Pedido</button>
        </div>
    </form>
      </div>
    </div>
    <div id="seccion-favoritos" class="card shadow-sm p-4 mt-4" style="display:none;">
      <div class="profile-header mb-4">
        <h5 class="mb-0">REPORTES</h5>
      </div>
      <form method="POST">
        <div class="caja">
        <h1>Generar Reporte</h1>
        <label for="fecha_pedido">Fecha del Pedido:</label><br>
        <input type="date" name="fecha_pedido"><br><br>

        <label for="id_pedido">ID del Pedido:</label><br>
        <input type="number" name="id_pedido"><br><br>

        <label for="nombre_empleado">Nombre del Empleado:</label><br>
        <input type="text" name="nombre_empleado"><br><br>

        <label for="nombre_cliente">Nombre del Cliente:</label><br>
        <input type="text" name="nombre_cliente"><br><br>

        <button type="submit">Buscar</button>
        </div>
      </form>

      <div class="contenido" style="margin-bottom: 100px;">
          {% if resultados %}
          <div class="subcontenido">
              <div class="titulo"><h2>Resultados:</h2></div><br>
              
                  <table border="1">
                    <tr>
                          <th>Fecha</th>
                          <th>Cliente</th>
                          <th>Dirección</th>
                          <th>Producto</th>
                          <th>Empleado</th>
                          <th>Estado</th>
                      </tr>
                      {% for row in resultados %}
                      <tr>
                          <td>{{ row.fecha }}</td>
                          <td>{{ row.cliente }}</td>
                          <td>{{ row.direccion }}</td>
                          <td>{{ row.productos | safe }}</td>
                          <td>{{ row.empleado }}</td>
                          <td>{{ row.estado }}</td>
                      </tr>
                      {% endfor %}

                  </table>
                  {% else %}
                      <div class="texto"><p>No se encontraron entregas con esos criterios.</p></div>
                  {% endif %}
              
          </div>
      </div>
    </div>
</div>

<!-- Modal Factura -->
<div class="modal fade" id="modalFactura" tabindex="-1" aria-labelledby="modalFacturaLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-receipt me-2"></i>Factura del pedido</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio unidad</th>
                            <th>Método de pago</th>
                            <th>Monto total</th>
                            <th>Fecha de pago</th>
                        </tr>
                    </thead>
                    <tbody id="factura-body"></tbody>
                </table>
                <div class="text-end">
                    <a id="btnDescargarPDF" href="#" class="btn btn-danger">
                        <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Registros de entrega -->
<div class="modal fade" id="modalRegistros" tabindex="-1" aria-labelledby="modalRegistrosLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-truck me-2"></i>Registros de entrega</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <table class="table table-striped align-middle">
                    <thead>
                        <tr>
                            <th>ID Registro</th>
                            <th>Empleado</th>
                            <th>Comentario</th>
                            <th>Fecha</th>
                        </tr>
                    </thead>
                    <tbody id="registros-body"></tbody>
                </table>
                <div id="fotos-entrega" class="d-flex flex-wrap gap-2 mt-3"></div>
            </div>
        </div>
    </div>
</div>



{% endblock %}

{% block extra_footer %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        crossorigin="anonymous"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const modalFacturaInstance = new bootstrap.Modal(document.getElementById('modalFactura'));
    const modalRegistrosInstance = new bootstrap.Modal(document.getElementById('modalRegistros'));

    document.addEventListener('click', async function(e) {
        // Ver factura
        const btnFactura = e.target.closest('.ver-factura-btn');
        if(btnFactura){
            const pedidoId = btnFactura.dataset.pedidoId;
            try {
                const res = await fetch(`/admin/factura/${pedidoId}`);
                const data = await res.json();
                if(data.error) throw new Error(data.error);
                let html = '';
                data.forEach(f => {
                    html += `
                    <tr>
                        <td>${f.NombreProducto}</td>
                        <td>${f.Cantidad}</td>
                        <td>$${f.PrecioUnidad}</td>
                        <td>${f.MetodoPago}</td>
                        <td>$${f.Monto}</td>
                        <td>${f.FechaPago}</td>
                    </tr>`;
                });
                document.getElementById('factura-body').innerHTML = html;
                document.getElementById('btnDescargarPDF').href = `/admin/factura/pdf/${pedidoId}`;
                modalFacturaInstance.show();
            } catch(err){
                console.error(err);
                alert('No se pudo cargar la factura. Intenta más tarde.');
            }
        }

        // Ver registros de entrega
        const btnEntrega = e.target.closest('.ver-registros-btn');
        if(btnEntrega){
            const pedidoId = btnEntrega.dataset.pedidoId;
            try {
                const res = await fetch(`/admin/registros_entrega/${pedidoId}`);
                const data = await res.json();
                if(!data.success) throw new Error(data.message || "No se pudieron cargar los registros.");

                let registros = data.registros || [];
                let html = '';
                let fotosHtml = '';

                if(registros.length === 0){
                    html = `<tr><td colspan="4" class="text-center text-muted">No hay registros de entrega para este pedido.</td></tr>`;
                } else {
                    registros.forEach(r => {
                        html += `
                        <tr>
                            <td>${r.ID_Registro}</td>
                            <td>${r.ID_Empleado}</td>
                            <td>${r.Comentario || '-'}</td>
                            <td>${r.FechaRegistro}</td>
                        </tr>`;
                        [r.Foto1, r.Foto2, r.Foto3].filter(f => f).forEach(f => {
                            fotosHtml += `<img src="/static/img/entregas/${f}" 
                                style="width:150px; height:150px; object-fit:cover; border-radius:8px;">`;
                        });
                    });
                }

                document.getElementById('registros-body').innerHTML = html;
                document.getElementById('fotos-entrega').innerHTML = fotosHtml || '<p class="text-muted">No hay fotos disponibles</p>';

                modalRegistrosInstance.show();
            } catch(err){
                console.error(err);
                alert('No se pudieron cargar los registros de entrega.');
            }
        }
    });

    // Sidebar navegación
    const secciones = {
        perfil: document.getElementById("seccion-perfil"),
        direcciones: document.getElementById("seccion-direcciones"),
        pedidos: document.getElementById("seccion-pedidos"),
        favoritos: document.getElementById("seccion-favoritos")
    };
    const menuLinks = document.querySelectorAll(".sidebar a");

    function mostrarSeccion(activa){
        Object.values(secciones).forEach(sec => { if(sec) sec.style.display = "none"; });
        menuLinks.forEach(link => link.classList.remove("active"));
        if(secciones[activa]) secciones[activa].style.display = "block";
        const menuId = `menu-${activa}`;
        const menuActivo = document.getElementById(menuId);
        if(menuActivo) menuActivo.classList.add("active");
    }

    menuLinks.forEach(link => {
    link.addEventListener("click", () => {
        menuLinks.forEach(l => l.classList.remove("active")); // Quita activo a todos
        link.classList.add("active"); // Activa solo el clicado
        mostrarSeccion(link.id.replace('menu-', ''));
    });
    });
    mostrarSeccion("perfil");

});

// Volver atrás
function volverAtras() {
    if (window.history.length > 1) {
        window.history.back();
    } else {
        window.location.href = "/";
    }
}
</script>
{% endblock %}
